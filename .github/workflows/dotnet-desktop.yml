name: Build and upload release artifacts

on:
  release:
    types: [published]

jobs:
  build-and-upload:
    # Only run for tags like v1.0.0, v2.0.0, etc.
    if: |
      startsWith(github.event.release.tag_name, 'v') &&
      endsWith(github.event.release.tag_name, '.0.0')
    runs-on: windows-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'  # matches net9.0-windows

      - name: Restore
        run: dotnet restore

      - name: Publish (Release, using csproj publish settings)
        run: dotnet publish ./Hangar.csproj -c Release -o ./publish

      - name: Create zip archive
        run: |
          powershell -Command "Compress-Archive -Path publish\* -DestinationPath Hangar-${{ github.event.release.tag_name }}-win-x64.zip"

      - name: Upload asset to GitHub Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: Hangar-${{ github.event.release.tag_name }}-win-x64.zip
          asset_name: Hangar-${{ github.event.release.tag_name }}-win-x64.zip
          asset_content_type: application/zip
